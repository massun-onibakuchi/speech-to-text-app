# Execution Plan: Issues #249, #252, #255, #267, #268

## Planning assumptions
- One issue maps to one PR (no bundled PRs).
- Priority order is based on user-facing impact and regression risk.
- #268 explicitly depends on a merged #267 baseline (shared shortcut-capture state contract).
- Backward-compatibility style branches/variants are intentionally removed where scope requires one current standard style.
- Each ticket must define exact test commands and deterministic assertions before PR approval.

## Priority order
1. P0 - #249 Bug: final output not added to Activity when `output-text=transformed-text`
2. P1 - #267 Bug: shortcut capture should cancel when focus is lost by outside click
3. P1 - #268 Bug: shortcut editor keeps stale validation error when starting a new recording (depends on #267)
4. P1 checkpoint - Integrated shortcut flow validation after #267 + #268
5. P2 - #255 Style: inconsistency in selection controls (provider/model/etc)
6. P3 - #252 Style: transformation pop-up menu inconsistent with app style

---

## Ticket #249 -> PR #1
Issue: https://github.com/massun-onibakuchi/speech-to-text-app/issues/249

### Goal
Ensure final transformed output is always appended to Activity, including delayed terminal completion beyond the initial short polling window.

### Checklist
- [ ] Reproduce delayed transformed output path with deterministic timing.
- [ ] Add late-result reconciliation path after initial poll window.
- [ ] Enforce idempotent Activity append (no duplicates).
- [ ] Verify parity across `raw-dictation` and `transformed-text` modes.
- [ ] Add/extend automated tests and update docs/changelog.

### Task chunks (step-by-step)
1. Baseline and reproduce
- Inspect `native-recording` finalization flow and current poll timeout (`8 x 600ms`).
- Add a test scenario where transformed terminal output arrives after the current timeout window.

2. Implement fix
- Add a post-timeout reconciliation path tied to submission/session id.
- Guard append operation with deduplication key so late updates cannot append twice.

3. Harden behavior
- Keep status text accurate while awaiting delayed completion.
- Ensure transformed and raw modes use equivalent completion guarantees.

4. Verify and document
- Run focused tests for `native-recording` and adjacent rendering behavior.
- Add release/docs note for delayed transformed completion handling.

### Gates
- Functional gate: Given delayed transformed output (>4.8s), Activity includes final transformed text without manual retry.
- Regression gate: Given immediate output in both modes, Activity entry count stays exactly 1.
- Command gate: `pnpm test -- src/renderer/native-recording.test.ts src/renderer/activity-feed.test.ts`
- Quality gate: `pnpm typecheck` passes.

---

## Ticket #267 -> PR #2
Issue: https://github.com/massun-onibakuchi/speech-to-text-app/issues/267

### Goal
Cancel shortcut capture immediately when focus leaves the active shortcut input (outside click, blur, or focus loss).

### State contract (output for #268 dependency)
- Canonical states: `idle`, `recording(fieldId)`, `canceled(fieldId)`, `committed(fieldId)`, `error(fieldId)`.
- Cancel event rules: outside click, `window.blur`, and explicit field blur transition `recording(fieldId)` to `canceled(fieldId)` synchronously.
- Cancel side effects: key interception stops immediately and `Recording...` is cleared in the same render cycle.

### Checklist
- [ ] Confirm current capture lifecycle and focus event handling.
- [ ] Implement cancel-on-focus-loss behavior for outside click and blur.
- [ ] Scope and cleanup listeners to prevent duplicate handlers.
- [ ] Add automated coverage for outside click and window blur.
- [ ] Update docs/changelog with the state contract.

### Task chunks (step-by-step)
1. Baseline
- Reproduce stuck capture (`Recording...` remains) in shortcut settings.
- Identify single source of truth for active capture session.

2. Implement cancel triggers
- Wire outside interaction and window blur to same cancel transition.
- Ensure event listeners are installed only during active recording and always removed on exit.

3. UX consistency
- Stop interception and clear recording indicator synchronously.
- Confirm canceled sessions never commit shortcut values.

4. Verify and document
- Add tests for outside click cancel and window blur cancel.
- Document state contract for #268 dependency.

### Gates
- Functional gate: Given active `recording(fieldId)`, outside click clears `Recording...` within one UI tick.
- Functional gate: Given active recording, `window.blur` cancels and no keybind is committed.
- Command gate: `pnpm test -- src/renderer/shortcut-capture.test.ts src/renderer/settings-recording-react.test.tsx`
- Quality gate: `pnpm typecheck` passes.

---

## Ticket #268 -> PR #3
Issue: https://github.com/massun-onibakuchi/speech-to-text-app/issues/268

### Goal
Clear stale shortcut-capture validation errors whenever a new recording session starts on a different field.

### Checklist
- [ ] Rebase on merged #267 and verify against the shared capture state contract.
- [ ] Reset previous error state when a new field starts recording.
- [ ] Keep error visibility scoped to active `fieldId`/session.
- [ ] Add tests for invalid combo on one field then recording on another field.
- [ ] Update docs/changelog note.

### Task chunks (step-by-step)
1. Baseline
- Locate storage/derivation path for capture validation error state.
- Reproduce stale error after invalid combo then target switch.

2. Implement fix
- Clear prior error on transition to `recording(newFieldId)`.
- Tie rendered error text to active session field id, not global stale state.

3. Preserve validation behavior
- Keep in-session errors visible for the same active field.
- Confirm no conflict with #267 cancel transitions.

4. Verify and document
- Add tests for field switch clearing stale errors.
- Update docs/changelog for error lifecycle correction.

### Gates
- Functional gate: Given error on field A, starting recording on field B removes field A error immediately.
- Functional gate: Given same active field, relevant validation error remains visible.
- Dependency gate: behavior conforms to #267 state contract with one capture state source.
- Command gate: `pnpm test -- src/renderer/shortcut-capture.test.ts src/renderer/settings-recording-react.test.tsx`
- Quality gate: `pnpm typecheck` passes.

---

## Ticket #255 -> PR #4
Issue: https://github.com/massun-onibakuchi/speech-to-text-app/issues/255

### Goal
Standardize select-like control styling across Audio Input, Profiles, and Settings tabs using the current app style system, without keeping legacy/backward-compat style variants.

### Checklist
- [ ] Inventory all select-like controls in scope tabs.
- [ ] Align all in-scope controls to one shared style implementation.
- [ ] Remove legacy style variants and compatibility branches.
- [ ] Verify business logic and selection behavior remain unchanged.
- [ ] Update targeted UI tests, a11y checks, and docs.

### Task chunks (step-by-step)
1. Baseline and scope lock
- Enumerate provider/model/input selection controls in Audio Input, Profiles, and Settings.
- Compare against `resources/artifacts-sample.zip` and current app token patterns.

2. Style unification
- Refactor to shared select-like classes/primitives only.
- Keep selection logic/data flow untouched.

3. Compatibility cleanup
- Delete fallback/legacy style class branches in targeted controls.
- Keep one canonical style path for select-like controls.

4. Verify and document
- Update snapshots/component tests for style changes.
- Add keyboard and accessibility checks (`Tab`, arrows, `Enter`, `Esc`, focus-visible, ARIA role/name).
- Attach before/after screenshots for each in-scope control state (default/hover/focus/disabled) and list changed component ids.
- Document intentional removal of backward-compat style variants.

### Gates
- Visual gate: all in-scope controls share the same design tokens/states (default/hover/focus/disabled).
- Non-regression gate: selecting provider/model/input yields unchanged values and events.
- A11y gate: keyboard navigation and focus-visible behavior pass in scoped tests.
- Cleanup gate: no remaining legacy style branch in targeted select-like components.
- Command gate: `pnpm test -- src/renderer/settings-recording-react.test.tsx src/renderer/settings-api-keys-react.test.tsx`
- Quality gate: `pnpm typecheck` passes.

---

## Ticket #252 -> PR #5
Issue: https://github.com/massun-onibakuchi/speech-to-text-app/issues/252

### Goal
Align transformation pop-up menu styling with existing app design tokens/patterns while preserving existing pick/change-default behavior.

### Checklist
- [ ] Audit pop-up menu style divergence from app patterns.
- [ ] Align menu visuals using existing tokens/primitives.
- [ ] Keep pick/change-default behavior and flow unchanged.
- [ ] Add/update targeted component tests and a11y checks.
- [ ] Update docs/changelog note.

### Task chunks (step-by-step)
1. Baseline and mapping
- Identify menu containers/items/states (hover/focus/selected/disabled).
- Map style differences against existing app menu primitives.

2. Style-only refactor
- Reuse shared primitives/classes; avoid business-logic edits.
- Keep handler wiring and side effects unchanged.

3. Behavioral verification
- Validate pick-and-run and change-default flows remain identical.
- Verify keyboard and mouse parity.

4. Verify and document
- Update affected component/service tests.
- Add keyboard and accessibility checks (`Tab`, arrows, `Enter`, `Esc`, focus-visible, ARIA role/name).
- Attach before/after screenshots for menu states (default/hover/focus/selected/disabled) and list changed component ids.
- Add docs/changelog note for style alignment.

### Gates
- Visual gate: pop-up menu matches established app spacing, typography, border/ring, and state styling.
- Scope gate: no behavior changes in pick/change-default actions.
- A11y gate: keyboard navigation and ARIA semantics remain valid.
- Command gate: `pnpm test -- src/renderer/settings-recording-react.test.tsx src/renderer/shell-chrome-react.test.tsx`
- Quality gate: `pnpm typecheck` passes.

---

## Cross-ticket execution notes
- Sequence: #249 -> #267 -> #268 -> integration checkpoint -> #255 -> #252.
- Mandatory integration checkpoint after #268: run combined shortcut flow tests before any style ticket.
- Integration command: `pnpm test -- src/renderer/shortcut-capture.test.ts src/renderer/settings-recording-react.test.tsx`
- Isolation rule: style tickets (#255, #252) must not modify shortcut capture state or recording finalization modules.
- Branch naming convention: `fix/249-...`, `fix/267-...`, `fix/268-...`, `style/255-...`, `style/252-...`.
- PR template requirement (each PR): include issue link, out-of-scope list, before/after evidence, and test proof.
